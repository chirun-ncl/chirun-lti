{% extends "dashboard.html" %}

{% set colfirst = 'col-1' %}
{% set colmid = 'col-2' %}
{% set collast = 'col-2' %}

{% block dashboard %}
	<h2>Adaptive Release</h2>
	{% if module.content | length == 0 %}
		<p>This item has no content. Please check your uploaded content's <code>config.yml</code> file.
	{% elseif (module.content | length == 1) and (module.content[0].children | length < 2) %}
		<p>This item is a standalone item or does not contain multiple pieces of content to release adaptively.</p>
		<p>Instead, manage visibility of the Coursebuilder content using the tools provided by your VLE.</p>
	{% else %}
		<p>Use the below controls to manage when content will be visible to students on a part or chapter basis.</p>
		<form action="index.php" method="POST">
			<button class="btn btn-primary" name="do" value="content_saveall">Save All Changes</button>
			<button class="btn btn-secondary" name="do" value="content_clearall">Restore Defaults</button>
			<table class="table">
				<thead class="thead-light">
						<tr>
						<th class="{{ colfirst }}" scope="col"></th>
						<th scope="col">Content Title</th>
						<th class="{{ colmid }}" scope="col">Current Visibility</th>
						<th class="{{ colmid }}" scope="col">Start Date &amp; Time</th>
						<th class="{{ colmid }}" cope="col">End Date &amp; Time</th>
						<th class="{{ collast }} text-nowrap text-center" scope="col">Force Hidden</th>
					</tr>
				</thead>
				{% for module_content in module.content %}
						{% if module_content.children | length > 0 %}
							<tbody>
								<tr class='table-primary'>
									<td class='clickable' data-bs-toggle='collapse' data-bs-target='#table-part-{{ module_content.slug_path | replace({"/": "_"}) }}' aria-expanded='false' aria-controls='table-part-{{ module_content.slug_path }}'>
										<i class="fa fa-3 fa-chevron-down"></i>
									</td>
									<td>{{ module_content.title }}</td>
									<td class="{{ colmid }}">{{ module_content.hidden_reason }}</td>
									<td>
										<input class="flatpickr" name="content[{{ module_content.slug_path }}][start_datetime]" type="text" value="{{ module_content.start_datetime }}">
									</td>
									<td>
										<input class="flatpickr" name="content[{{ module_content.slug_path }}][end_datetime]" type="text" value="{{ module_content.end_datetime }}">
									</td>
									<td class="text-center {{ collast }}">
										<input type="checkbox" name="content[{{ module_content.slug_path}}][checked]" {% if module_content.hidden == 1 %}checked{% endif%}>
									</td>
								</tr>
								<tr>
									<td colspan="6" class="p-0">
											<div id='table-part-{{ module_content.slug_path | replace({"/": "_"}) }}' class='collapse show'>
											<table class="table table-striped table-borderless m-0 align-middle">
												<tbody>
													{% for child_content in module_content.children %}
														{% if child_content.type != 'url' %}
														<tr>
															<td class="{{ colfirst }}"></td>
															<td>{{ child_content.title }}</td>
															<td class="{{ colmid }}">{{ child_content.hidden_reason }}</td>
															<td class="{{ colmid }}">
																<input class="flatpickr" name="content[{{ child_content.slug_path }}][start_datetime]" type="text" value="{{ child_content.start_datetime }}">
															</td>
															<td class="{{ colmid }}">
																<input class="flatpickr" name="content[{{ child_content.slug_path }}][end_datetime]" type="text" value="{{ module_content.end_datetime }}">
															</td>
															<td class="text-center {{ collast }}">
																<input type="checkbox" name="content[{{ child_content.slug_path}}][checked]" {% if child_content.hidden == 1 %}checked{% endif%}>
															</td>
														</tr>
														{% endif %}
													{% endfor %}
												</tbody>
											</table>
										</div>
									</td>
								</tr>
							</tbody>
						{% elseif module_content.type != 'url' %}
							<tbody>
								<tr>
									<td class="{{ colfirst }}"></td>
									<td>{{ module_content.title }}</td>
									<td class="{{ colmid }}">{{ module_content.hidden_reason }}</td>
									<td class="{{ colmid }}">
										<input class="flatpickr" name="content[{{ module_content.slug_path }}][start_datetime]" type="text" value="{{ module_content.start_datetime }}">
									</td>
									<td class="{{ colmid }}">
										<input class="flatpickr" name="content[{{ module_content.slug_path }}][end_datetime]" type="text" value="{{ module_content.end_datetime }}">
									</td>
									<td class="text-center {{ collast }}">
										<input type="checkbox" name="content[{{ module_content.slug_path }}][checked]" {% if module_content.hidden == 1 %}checked{% endif%}>
									</td>
								</tr>
							</tbody>
						{% endif %}
				{% endfor %}
			</table>
			<input type="hidden" name="dashpage" value="adapt"></input>
			<button class="btn btn-primary" name="do" value="content_saveall">Save All Changes</button>
			<button class="btn btn-secondary" name="do" value="content_clearall">Restore Defaults</button>
		</form>
		<script>
			window.addEventListener('load', function () {
				flatpickr(".flatpickr", {enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true});
			});
		</script>
	{% endif%}
{% endblock %}